<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Расписание ПТК НовГУ</title>
	<style>
		table, th, td {
			border: 1px solid black;
			border-collapse: collapse;
		}
		td.mergedTop {
			border-bottom: 1px dotted black;
		}
		td.mergedBottom {
			border-top: 1px dotted black;
		}
		th {
			font-family: "Times New Roman", Times, sans-serif;
			padding: 5px;
			max-width: 1em;
			vertical-align: bottom;
		}
		td {
			padding: 5px;
		}
		.rotate {
			-moz-transform: rotate(-90.0deg);
			-o-transform: rotate(-90.0deg);
			-webkit-transform: rotate(-90.0deg);
			transform: rotate(-90.0deg);
			margin-bottom: 0;
		}
		.time {
			margin: 0 auto;
			text-align: center;
		}
	</style>
</head>
<body>
	<h3>Расписание для группы: <select id="groups"></select></h3>
	<h4>Текущая неделя: <span id="weekType"></span></h4>
	<div id="container"></div>
	<script src="js/jquery.js"></script>
	<script src="js/jquery.cookie.js"></script>
	<script type="text/javascript">
		var days = ["Понедельник", "Вторник", "Среда", "Четверг", "Пятница", "Суббота", "Воскресенье"];

		function sizeOf(obj) {
			var size = 0;
			for (var i = 0; i < obj.length; i++) {
				if (typeof(obj[i]) == "string") {
					size++;
				} else {
					size += 2;
				}
			}
			return size;
		};

		function loadSchedule(group) {
			$.ajax({
				url: "php/full.php",
				data: "group=" + group,
				success: function(data){
					var response = $.parseJSON(data);
					if (response.lowWeek) {
						$("#weekType").html("нижняя");
					} else {
						$("#weekType").html("верхняя");
					}

					$("#container").html("<table>");
					for (var i = 0 ; i < response.days.length; i++) {
						var content = "<tr><th rowspan=" + sizeOf(response.days[i].schedule) +
									  "><p class=\"rotate\">" + days[i] + "</p></th>";
						time = response.days[i].time[0].split("-");
						if (typeof(response.days[i].schedule[0]) == "string") {
							content += "<td><p class=\"time\">" + time[0] + "</p><p class=\"time\">" +
										time[1] + "</p></td><td>" + response.days[i].schedule[0] + "</tr>";
						} else {
							content += "<td rowspan=\"2\"><p class=\"time\">" + time[0] + "</p><p class=\"time\">" +
										time[1] + "</p></td><td  class=\"mergedTop\">" + response.days[i].schedule[0].top +
									   "</tr><tr><td  class=\"mergedBottom\">" + response.days[i].schedule[0].bottom + "</td>";
						}
						content += "</tr>"

						for (var j = 1; j < response.days[i].schedule.length; j++) {
							content += "<tr>"
							time = response.days[i].time[j].split("-");
							if (typeof(response.days[i].schedule[j]) == "string") {
								content += "<td><p class=\"time\">" + time[0] + "</p><p class=\"time\">" + time[1] +
										   "</p></td><td>" + response.days[i].schedule[j] + "</td>";
							} else {
								content += "<td rowspan=2><p class=\"time\">" + time[0] + "</p><p class=\"time\">" +
											time[1] + "</p></td><td  class=\"mergedTop\">" + response.days[i].schedule[j].top +
										   "</td></tr><tr><td  class=\"mergedBottom\">" + response.days[i].schedule[j].bottom + "</td>";
							}
							content += "</tr>"
						}
						$("#container").append(content);
					}
					$("#container").append("</table>");
				}
			});
		}

		$.ajax({
			url: "groupList",
			dataType: "text",
			success: function(data){
				var groups = data.match(/[^\r\n]+/g);
				var defaultGroup = $.cookie("group");
				if ($.inArray(defaultGroup, groups) < 0) {
					defaultGroup = groups[0];
					$.cookie("group", defaultGroup);
				}
				for (var i = 0; i < groups.length; i++) {
					$("#groups").append("<option value=\"" + groups[i] + "\">" + groups[i] + "</option>");
				}
				$("#groups").val(defaultGroup);
				loadSchedule(defaultGroup);
			}
		});

		$("#groups").change(function() {
			loadSchedule($(this).val());
			$.cookie("group", $(this).val());
		});
	</script>
</body>
<html>
